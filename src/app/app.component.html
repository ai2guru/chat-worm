<div class="chat-container">
  <div class="d-flex justify-content-between align-items-center">
    <button class="btn btn-primary toggle-button" (click)="toggleChatHeader()"
            [ngClass]="{'collapsed': isChatHeaderCollapsed}">
      <ng-container *ngIf="!isChatHeaderCollapsed; else isCollapsed">
        <i class="bi bi-chevron-up"></i>
      </ng-container>
      <ng-template #isCollapsed>
        <i class="bi bi-chevron-down"></i>
      </ng-template>
    </button>
    <button (click)="openUsageWebsite()" class="progress-bar" role="progressbar" [attr.aria-valuenow]="total_used"
         [attr.aria-valuemin]="0" [attr.aria-valuemax]="total_granted">Usage: {{total_used|currency}}
      / {{total_granted|currency}}</button>
    <div class="d-flex">
      <button class="btn btn-primary" (click)="showTipModal = true;">
        <i class="bi bi-currency-bitcoin"></i>
      </button>
      <button class="btn btn-primary" (click)="toggleDarkMode()">
        <i class="bi bi-moon"></i>
      </button>
    </div>
  </div>
  <app-tip-modal *ngIf="showTipModal" (close)="showTipModal = false;"></app-tip-modal>
  <app-info-modal *ngIf="showInfoModal" (close)="showInfoModal = false;"></app-info-modal>
  <div class="chat-header">
    <div class="d-flex justify-content-between align-items-center">
      <div class="d-flex align-items-center">
        <i class="bi bi-chat-heart-fill mb-0 ml-2 fs-2 me-3"></i>
        <h2 class="mb-0 ml-2">Chat with ChatGPT via API</h2>
        <button class="btn btn-primary" (click)="showInfoModal = true;">
          <i class="bi bi-info-circle"></i>
        </button>
      </div>
    </div>
    <br/>
    <p>Chat with me even when <a href="https://chat.openai.com/chat" target="_blank">https://chat.openai.com/chat</a> is
      down.<br/>
      Without the usual delays and too many requests in 1h.</p>
    <div class="row">
      <div class="d-flex">
        <div class="col-md-8">
          <div class="d-flex">
            <input [type]="showPassword ? 'text' : 'password'" [(ngModel)]="apikey" placeholder="Enter API Key..."
                   (input)="refreshModels()">
            <button (click)="showPassword = !showPassword;"><i class="bi bi-eye"></i></button>
          </div>
        </div>
        <button (click)="openApiKeyWebsite()">Get API Key</button>
      </div>
    </div>
    <p>Model to use: <select class="btn btn-primary" [(ngModel)]="selectedModel">
      <option *ngFor="let model of models" [value]="model.id">
        {{model.id}}
      </option>
    </select>
    </p>
    <div class="d-flex align-items-center">Randomness: <input type="range" min="0" max="2" step="0.1"
                                                              [(ngModel)]="temperature"> ({{temperature}})
    </div>
  </div>
  <div class="chat-messages" #messageContainer>
    <div class="chat-message" *ngFor="let message of messages">
      <ng-container *ngIf="message.isUser; else systemMessage">
        <div class="message-content message-content-right">
          {{message.content}}
          <div class="message-timestamp">{{ message.timestamp | date:'shortTime' }}</div>
        </div>
        <div class="message-avatar" [innerHTML]="message.avatar"></div>
      </ng-container>
      <ng-template #systemMessage>
        <div class="message-avatar" [innerHTML]="message.avatar"></div>
        <div class="message-content message-content-left">
          <ng-container *ngIf="!message.isRaw; else rawMessage">
            <div [innerHTML]="message.content">
            </div>
          </ng-container>
          <ng-template #rawMessage>
            <div>
              {{message.contentRaw |json}}
            </div>
          </ng-template>
          <div class="d-flex justify-content-end">
            <div class="message-timestamp">{{ message.timestamp | date:'shortTime' }}</div>
            <button class="raw" (click)="message.isRaw = !message.isRaw"><i class="bi bi-braces"></i></button>
          </div>
        </div>
      </ng-template>
    </div>
    <div class="chat-message chatbot-typing" *ngIf="chatbotTyping">
      <div class="message-avatar">
        <div class="message-avatar"><i class="bi bi-laptop"></i></div>
      </div>
      <div class="message-content message-content-left">
        <br/>
        <div class="typing-indicator">
          <span></span>
          <span></span>
          <span></span>
        </div>
      </div>
    </div>
  </div>
  <div class="chat-input">
    <div class="d-flex">
      <div class="col-md-10">
        <textarea [(ngModel)]="messageInput" type="text" placeholder="Type a message..."
                  (keydown.enter)="$event.preventDefault();sendMessage()"></textarea>
      </div>
      <div class="col-md-2">
        <div class="d-flex">
          <button (click)="sendMessage()"><i class="bi bi-send"></i></button>
          <button (click)="resendLastMessage()"><i class="bi bi-arrow-repeat"></i></button>
        </div>
      </div>
    </div>
  </div>
</div>

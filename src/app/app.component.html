<div class="chat">
  <app-header-component></app-header-component>
  <div class="chat-container">
    <div class="chat-header d-flex justify-content-between">
      <div class="d-flex">
        <button class="btn btn-primary toggle-button" (click)="toggleChatHeader()"
                [ngClass]="{'collapsed': isChatHeaderCollapsed}">
          <ng-container *ngIf="!isChatHeaderCollapsed; else isCollapsed">
            <i class="bi bi-chevron-up"></i>
          </ng-container>
          <ng-template #isCollapsed>
            <i class="bi bi-chevron-down"></i>
          </ng-template>
        </button>
        <button class="btn btn-primary" (click)="openInfoDialog()">
          <i class="bi bi-info-circle"></i>
        </button>
      </div>
      <div class="d-flex">
        <app-usage [apiKey]="apiKey" #usageComponent></app-usage>
        <button class="btn btn-primary" (click)="openTipDialog()">
          <i class="bi bi-currency-bitcoin"></i>
        </button>
        <button class="btn btn-primary" (click)="toggleDarkMode()">
          <i class="bi" [ngClass]="{'bi-moon': !darkModeEnabled, 'bi-sun': darkModeEnabled}"></i>
        </button>
      </div>
    </div>
    <div class="chat-settings">
      <div class="row">
        <div class="col-md-8 d-flex">
          <input class="input-api" [type]="showPassword ? 'text' : 'password'" [(ngModel)]="apiKey"
                 placeholder="Enter API Key..."
                 (input)="onTypeApiKey()">
          <button class="api-button" (click)="showPassword = !showPassword;"><i class="bi bi-eye"></i></button>
          <button class="api-button" (click)="openApiKeyWebsite()">Get API Key</button>
        </div>
        <div class="d-flex align-items-center">
          <p class="p-left-column">Model:</p>
          <select class="btn btn-primary" [(ngModel)]="selectedModel">
            <option *ngFor="let model of models" [value]="model.id">
              {{model.id}}
              <p *ngIf="model.id === 'gpt-3.5-turbo'">(default)</p>
            </option>
          </select>
        </div>
        <div class="d-flex align-items-center">
          <div class="p-left-column">
            <p>Randomness: {{temperature}}
              <br>
              <span *ngIf="temperature === 0.7">(default)</span>
              <span *ngIf="temperature !== 0.7">(The default value is 0.7)</span>
            </p>
          </div>
          <input class="input-randomness" type="range" min="0" max="2" step="0.1" [(ngModel)]="temperature">
        </div>
        <div class="d-flex align-items-center">
          <div class="p-left-column">
            <p>Max Tokens:
              <br>
              <span *ngIf="maxTokens === 256">(default)</span>
              <span *ngIf="maxTokens !== 256">(The default value is 256)</span>
            </p>
          </div>
          <input class="input-max-tokens"
                 type="number"
                 min="1"
                 step="1"
                 (keypress)="onInputOnlyAllowPositiveIntegers($event)"
                 [(ngModel)]="maxTokens">
        </div>
      </div>
    </div>
    <div class="chat-messages" #messageContainer>
      <app-info *ngIf="messages.length === 0"></app-info>
      <div class="chat-message" *ngFor="let message of messages">
        <ng-container *ngIf="message.isUser; else systemMessage">
          <div class="message-content message-content-right">
            <p class="p-message-content">{{message.content}}</p>
            <div class="message-timestamp">{{ message.timestamp | date:'shortTime' }}</div>
          </div>
          <div class="message-avatar" [innerHTML]="message.avatar"></div>
        </ng-container>
        <ng-template #systemMessage>
          <div class="message-avatar" [innerHTML]="message.avatar"></div>
          <div class="message-content message-content-left">
            <ng-container *ngIf="!message.isRaw; else rawMessage">
              <div [innerHTML]="message.content">
              </div>
            </ng-container>
            <ng-template #rawMessage>
              <div>
                <pre>{{message.contentRaw}}</pre>
              </div>
            </ng-template>
            <div class="d-flex justify-content-end">
              <div class="message-timestamp">{{ message.timestamp | date:'shortTime' }}</div>
              <button class="raw" (click)="message.isRaw = !message.isRaw; highlightCode()"><i class="bi bi-braces"></i>
              </button>
            </div>
          </div>
        </ng-template>
      </div>
      <div class="chat-message chatbot-typing" *ngIf="chatbotTyping">
        <div class="message-avatar">
          <img src="/assets/chatworm_simple.png" alt="Chatworm" width="50px"/>
        </div>
        <div class="message-content message-content-left">
          <br/>
          <div class="typing-indicator">
            <span></span>
            <span></span>
            <span></span>
          </div>
        </div>
      </div>
    </div>
    <app-chat-prompt-component [apiKey]="apiKey" (sendMessage)="sendMessage($event)"
                               (resendMessage)="resendLastMessage()">
    </app-chat-prompt-component>
  </div>
</div>
